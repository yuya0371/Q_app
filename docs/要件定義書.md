# 要件定義書（ドラフト）— Q.（仮） ※2026-02-03時点

## 0. アプリ概要（確定）
- アプリ名（仮）：Q。
- 目的：毎日1つ来る「今日の質問」に短文で答えることで、フォローしている人の回答が見れる“日課SNS”。
- ターゲット：学生（中高生〜大学生）。
- 方針：普通のSNS化（拡散/おすすめ/ランキング）を避ける。

## 1. 公開範囲・タイムライン（確定）
### 1.1 タイムライン
- タイムラインは「全体」なし。フォローしている人の“今日の回答”のみ表示。
- 回答閲覧は「自分が回答したら解放」型（未回答だと他人の回答は見れない）。

### 1.2 閲覧範囲（ユーザー側設定）
- ユーザーが設定画面で自分の回答の公開範囲を選択可能：
  - 相互フォローのみ閲覧可
  - フォローしてくれた人まで閲覧可（片側フォローでも可）
- デフォルト：相互フォローのみ閲覧可

### 1.3 コメント
- MVPでは無し。

## 2. 今日の質問（確定＋運用方式確定）
### 2.1 日次仕様
- 1日1問、暦日で固定（日本向け・JST固定）。
- 通知/公開タイミング：毎日10:00〜21:00の間でランダム。

### 2.2 公開/判定
- 公開時刻は「毎日0:00に乱数で決定してDBに保存」する（当日中に公開時刻は固定）。
- 公開処理は EventBridge の定期スケジュール → Lambda で実行する。失敗時は EventBridge のリトライに頼れる前提。

### 2.3 オンタイム判定
- 公開から30分以内に回答 → On-time
- 以降は Late（ただし次の質問まで回答可能）
- Late表示：分数を表示し、長すぎる場合は丸め表示（例：180m+ / 1d+）。

### 2.4 一覧表示ルール
- 並び順：On-time優先 →（同カテゴリ内は）投稿が早い順。
- 自分の投稿も並び順ルールに従う（先頭固定しない）。
- 一覧は詳細画面なし、本文もそのまま表示。

### 2.5 フォールバック（確定）
- 当日の質問レコードが無い/公開ジョブ失敗などでも「予備お題（fallback question）」を返して“1日1問”体験を維持する。
- 予備お題が発動した事実はユーザーに見せない。

## 3. 投稿（今日の回答）仕様（確定）
- テキストのみ、最大80文字、改行OK。
- URLは禁止（http/https等が含まれる投稿は弾く）。
- 編集：不可。
- 削除：可。削除すると未回答扱いになり、他人の回答が見れなくなる。
- 削除後の再投稿：不可（その日は新規投稿できない）。
- 復活：削除済み投稿をそのまま復活できる（削除取り消し）。
- 自分の履歴：削除済みも「削除済み」ラベルで表示し、復活導線を置く。
- 過去回答の閲覧：
  - 自分の過去回答：閲覧可能（履歴として一覧表示）
  - 他人の過去回答：閲覧不可（今日の回答のみ表示）

## 4. 認証・アカウント（確定＋追記確定）
### 4.1 対応OS
- iOS＋Android前提（ただしMVPリリースはiOS先行、Androidは後述）。

### 4.2 サインイン方式
- メール＋パスワードのみ（MVP）。
- 複数デバイス同時ログイン：許可。
- メール確認：必須（確認コードで有効化）。
- パスワード：最小8文字、複雑性必須なし、長いパスフレーズも許容（最大は少なくとも64文字想定）。
- パスワードリセット：メールにコード送信 → 新パスワード設定（Cognito標準フロー）。
- メールアドレス変更：可能（新メールアドレスに確認コードを送信して変更）。
- 年齢制限：13歳以上（13歳未満は登録不可）。
  - 確認方法：登録時に生年月日を入力、13歳未満は登録不可。
  - 生年月日：ユーザー情報として保存する。

#### 追記（確定）
- メールアドレスは大小区別しない（登録・ログイン時に小文字へ正規化する方針）。  
- Cognitoの内部usernameはランダムUUIDにする。ログインはemail（alias）＋パスワードで行う。  

### 4.3 オンボーディング/プロフィール
- 初回ログイン直後に「アプリ内ID作成」を必須。
- アプリ内ID：MVP固定（変更不可、将来TODO）。
- 表示名：任意、後で変更可。
  - 文字数：1〜20文字
  - 絵文字：不可
  - 使用可能文字：英数字・ひらがな・カタカナ・漢字・スペース・ハイフン(-)・アンダースコア(_)
  - 未設定時：アプリ内IDを表示
- プロフィール画像（アイコン）：
  - アップロード可能、任意
  - 未設定時：ユーザーIDを元にランダム生成（色・パターン）
  - 受付形式：JPEG、PNG（HEICはアップロード時にJPEGへ変換）
  - アップロード上限：5MB
  - 保存：サーバー側で512x512のJPEGにリサイズして保存
  - 不適切画像対応：通報で対応（MVPでは自動審査なし）

#### 追記（アプリ内ID ルール：確定）
- 文字数：3〜15文字
- 文字種：英小文字(a-z) + 数字(0-9) + アンダースコア(_)のみ
- 先頭：英字
- 大小区別：しない（入力は小文字に正規化）
- 予約語：admin / support は登録不可

### 4.4 ユーザー検索
- ID完全一致検索。
- 検索結果にID＋表示名＋アイコンを表示。

### 4.5 フォロー
- 片側フォロー可、フォロー申請なし。
- フォロー数上限：なし（MVP）。
- レート制限：MVPでは制限なし。問題発生時に1日あたりの上限を追加できる設計にしておく。
- フォロー/フォロワー一覧：
  - 自分：フォロー一覧・フォロワー一覧どちらも閲覧可能
  - 他人：人数のみ表示（一覧は後日追加検討）

## 5. 安全対策（審査対策込みで確定）
- UGC（投稿）ありのため、通報/ブロック/フィルタ/運用対応を要件化。App StoreのUGC要件に合わせて、ブロック・通報・フィルタ・迅速対応を明示する。 [web:80]
- ブロック：完全遮断（検索にも出ない、相互なら解除、コンテンツも相互に見えない）。

#### 追記（ブロック時のフォロー関係：確定）
- ブロックした瞬間に、双方のフォロー/フォロワー関係を自動で解除する。

- 通報：ユーザー通報＋投稿通報をMVPに入れる（カテゴリ＋自由記述）。
  - カテゴリ：スパム / 嫌がらせ・いじめ / 不適切なコンテンツ / なりすまし / 個人情報の公開 / その他
- 運用：通報は運営が確認して対応、24時間以内に対応の方針を要件に書く。
- NGワード：投稿を弾かず、表示時に本人含めてマスク（*）する。
- NGワード検知投稿は flagged フラグを付けて保存し、運営が後から一覧で見れるようにする。

## 6. リアクション（確定＋追記確定）
- 投稿に対して簡単なリアクションを付与できる。
- 1人1投稿につきリアクション最大1つ、変更・解除OK。
- リアクション数（カウント）は表示しない（MVP）。

#### 追記（確定）
- リアクションは固定セット: ❤️ 🔥 😂 🤔 👀（5種類）
- 後から種類を追加できる設計にする。  

## 7. 通知（確定）
- MVPでの通知対象：「今日の質問」公開時のみ（フォロー通知・リアクション通知は後日追加）。
- アプリ内通知ON/OFF設定画面は作らず、OS設定に任せる（MVP）。
- 通知がOFFのときは、アプリ内から通知設定へ誘導（iOSは通知設定URLへ遷移できる）。
- 許可リクエストは文脈付き（「今日の質問を見逃さないため」）で出す。

## 8. アカウント削除（退会）要件（確定＋追記確定）
### 8.1 退会導線（確定）
- アプリ内からアカウント削除を開始できる導線を用意（プロフィール画面等）。
- Apple要件：アカウント作成をサポートするアプリは、アプリ内から削除開始できる必要がある。 [web:85]

### 8.2 退会時の基本方針（確定）
- 退会＝完全削除（物理削除）。投稿・リアクション・フォロー・ブロック・通報・プロフィール等、アプリ内データは全削除。
- 退会後の痕跡：相手側の画面からも完全に消す（「退会済み」表示などはしない）。

#### 追記（確定）
- クーリングオフ/猶予期間は設けない（開始したら取り消し不可で順次物理削除まで進める）。
- 退会後の再登録：同じメールアドレスで再登録可能。

### 8.3 完了タイミングとUI（確定）
- 退会操作後：即ログアウト＋「削除を開始しました」表示。
- 確認ステップ：確認ダイアログ1回（「復元できません」等）。

### 8.4 バックエンド削除フロー（確定）
- 削除は段階削除（ページングしながら順次削除）で、完了保証は Step Functions（Standard）で行う。
- Step Functions：Standardを採用（監査/長時間実行向き）。
- 二重実行防止：deleteUser-{userId} のように実行名を固定し、二重起動を抑止。
- 二重起動時の挙動：成功扱い（“削除開始済み”として同じ実行を参照/返す設計）。

### 8.5 セッション終了（確定）
- 退会開始時に AdminUserGlobalSignOut 相当でセッションを終了させる。

### 8.6 削除の順番（確定）
1) AdminUserGlobalSignOut（全デバイスサインアウト）  
2) アプリ内データ削除（DynamoDB等）  
3) Cognitoユーザー削除（AdminDeleteUser）

### 8.7 失敗時の運用（確定）
- 失敗時は運営が手動で復旧可能にする。
- 復旧方式：Step Functions の redrive（途中から再開）を基本とする。 [web:60]
- 操作場所：MVPはAWSコンソールで運用（管理画面は作らない）。
- 権限：運営担当にも最小権限で付与（redrive/実行確認のみ）。MFA必須。

### 8.8 Web削除導線（方針確定：後回し）
- MVPではWeb導線は作らない。
- ただし Google Play は「アプリ内導線＋Webリンク」の要件があるため、Androidリリース前に必ずWeb導線を追加する。 [web:87]
- リリース順：iOS先行公開、AndroidはWeb導線実装後に公開。

## 9. お題生成・ユーザーお題（Aの決定分：確定）
### 9.1 初期投入（確定）
- 運営お題：100問用意（バックアップ/在庫）。
- “毎日1問”はフォールバック含め保証。

### 9.2 ユーザー投稿お題（MVPから入れる、確定）
- MVPから導入するが 運営承認制（承認されるまで「今日の質問」には採用しない）。
- 提出頻度：1日1件まで。
- 提出条件：「今日の回答」を投稿した人のみ提出可能。
- 形式：テキストのみ、最大80文字、改行OK。
- URL禁止：お題もhttp/https等が含まれる場合は弾く。
- NGワード検知：flaggedは“要審査キュー”へ（自動却下しない）。
- 却下理由：ユーザーには返さない（理由表示なし）。
- クレジット：採用されたお題の投稿者表示はしない（匿名）。
- ステータス表示：審査中/採用/却下などの状態をUIに出さない。
- 送信時レスポンス：成功時は常に「受け付けました」等の固定文言、入力エラー（URL/文字数など機械判定）のみその場で理由を返す。
- 提出UI：今日の回答を投稿した後に「お題を提案する」ボタンを表示。

### 9.3 採用ロジック（確定）
- 優先：基本的にユーザー承認お題を優先。
- 選び方：承認済みユーザーお題からランダム。
- 被り防止：直近30日は同じお題を出さない。
- 在庫不足時：被り防止を緩めず、運営お題に切り替える（ユーザー優先より安定優先）。

## 10. 技術スタック（確定）
### 10.1 モバイルアプリ
- React Native + Expo（Managed workflow）
- iOS/Android両対応、コードベース共通
- 対応言語：MVPは日本語のみ（多言語対応可能な構造にしておく）
- バージョン管理：強制アップデート対応（最低バージョンを下回ったらアプリ使用不可）
- オフライン時：キャッシュした過去データは閲覧可能、投稿・リアクション等はオンライン必須
- 招待・共有機能：
  - プロフィールへのリンク共有
  - QRコード生成（プロフィールへの導線）
  - SNS共有対応（Instagram ストーリー等）
- ディープリンク対応：
  - インストール済み → アプリ内の該当画面を開く
  - 未インストール → App Store / Google Play へ誘導
- ダークモード：対応（OS設定に連動してライト/ダーク切り替え）
- テーマカラー（暫定、後から変更可能な設計にする）：
  - メイン：黒 `#1A1A1A`
  - アクセント：パープル `#8B5CF6`
- ドメイン：リリース前に取得予定（開発中は仮ドメインで進める）

### 10.2 バックエンド
- 言語：Node.js（TypeScript）
- API：REST API（Amazon API Gateway + AWS Lambda）
- 認証：Amazon Cognito
- DB：Amazon DynamoDB
- ストレージ：Amazon S3（プロフィール画像）
- 定期処理：Amazon EventBridge + AWS Lambda
- 退会処理：AWS Step Functions（Standard）
- プッシュ通知：Expo Push Notifications（Lambda から Expo Push API を呼び出し）
- IaC：AWS CDK（TypeScript）
- 環境：開発(dev) + 本番(prod) の2環境
- エラー監視：Sentry（アプリ + Lambda）+ CloudWatch（補助）
- テスト：ユニットテスト中心（重要なロジックのみ）、E2Eは後日検討
- CI/CD：GitHub Actions（EAS Build連携 + CDKデプロイ自動化）

### 10.3 管理画面
- Web（React）

## 11. 管理画面（確定）
- Web管理画面を構築する。
- 認証：IAM + Cognito Identity（AWSユーザーとして認証）。
- 管理者：複数人、権限レベルは分けない（全員同じ権限）。
- MVPでの機能：
  1. お題管理：運営お題の追加・編集 / ユーザーお題の承認・却下
  2. 通報管理：通報一覧の確認・対応ステータス更新
  3. ユーザー管理：ユーザー検索・詳細確認・BAN（アカウント停止）/ BAN解除
     - BAN時の挙動：ログイン不可（既存セッションも強制ログアウト）
     - BAN解除：管理画面から可能
  4. NGワード管理：NGワードの追加・削除
  5. flagged投稿一覧：NGワード検知された投稿の確認

## 12. 利用規約・プライバシーポリシー
- MVP開発後、リリース前に用意する（App Store / Google Play 審査で必須）。
- 利用規約：禁止行為、免責事項など
- プライバシーポリシー：収集データ、利用目的など

## 13. 成果物（ドキュメント）
以下のドキュメントを作成する：

| ドキュメント | 内容 |
|---|---|
| 要件定義書 | 機能・仕様の定義（本ドキュメント） |
| DB設計書 | テーブル定義、インデックス設計 |
| API設計書 | エンドポイント一覧、リクエスト/レスポンス定義 |
| 画面設計書 | ワイヤーフレーム、画面遷移図 |
| システム構成図 | AWS構成、インフラ全体像 |
| タスク管理表 | 開発タスクの進捗管理 |
| 運用手順書 | 日常運用（お題承認、通報対応等） |
| 障害対応マニュアル | トラブル時の対応フロー |
| リリースチェックリスト | App Store / Google Play 申請前の確認項目 |
| テスト仕様書 | テストケース一覧 |
