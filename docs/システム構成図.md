# システム構成図 — Q.（仮）

## 1. 全体構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  クライアント                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────┐         ┌─────────────┐         ┌─────────────┐        │
│    │   iOS App   │         │ Android App │         │  管理画面    │        │
│    │ (Expo/RN)   │         │ (Expo/RN)   │         │  (React)    │        │
│    └──────┬──────┘         └──────┬──────┘         └──────┬──────┘        │
│           │                       │                       │               │
└───────────┼───────────────────────┼───────────────────────┼───────────────┘
            │                       │                       │
            │         HTTPS         │         HTTPS         │
            ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                    AWS                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        Amazon CloudFront                           │    │
│  │                    (CDN / 管理画面ホスティング)                      │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│           ┌────────────────────────┼────────────────────────┐              │
│           ▼                        ▼                        ▼              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   Amazon S3     │    │ Amazon Cognito  │    │ API Gateway     │        │
│  │ (静的ファイル)   │    │   (認証)        │    │  (REST API)     │        │
│  │ - 管理画面      │    │ - ユーザープール │    │  - /v1/*        │        │
│  │ - プロフィール画像│    │ - JWT発行       │    │  - /admin/v1/*  │        │
│  └─────────────────┘    └─────────────────┘    └────────┬────────┘        │
│                                                         │                  │
│                                                         ▼                  │
│                                              ┌─────────────────┐           │
│                                              │  AWS Lambda     │           │
│                                              │  (API Handler)  │           │
│                                              │  - Node.js/TS   │           │
│                                              └────────┬────────┘           │
│                                                       │                    │
│           ┌───────────────────────┬──────────────────┼──────────────┐     │
│           ▼                       ▼                  ▼              ▼     │
│  ┌─────────────────┐    ┌─────────────────┐  ┌───────────┐  ┌───────────┐ │
│  │ Amazon DynamoDB │    │   Amazon S3     │  │  Sentry   │  │ Expo Push │ │
│  │   (データ)      │    │ (プロフィール画像)│  │ (監視)    │  │   API     │ │
│  │ - Users         │    └─────────────────┘  └───────────┘  └───────────┘ │
│  │ - Answers       │                                                       │
│  │ - Questions     │                                                       │
│  │ - Follows       │                                                       │
│  │ - etc...        │                                                       │
│  └─────────────────┘                                                       │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        定期処理 / バッチ                            │    │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌────────────────┐ │    │
│  │  │ EventBridge     │───▶│  Lambda         │───▶│ DynamoDB       │ │    │
│  │  │ (スケジューラ)   │    │ - 質問公開      │    │ - 更新         │ │    │
│  │  │ - 毎日0:00      │    │ - 公開時刻決定   │    └────────────────┘ │    │
│  │  │ - 公開時刻      │    └─────────────────┘                       │    │
│  │  └─────────────────┘                                              │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        退会処理                                     │    │
│  │  ┌─────────────────┐    ┌─────────────────────────────────────┐   │    │
│  │  │ API Gateway     │───▶│  Step Functions (Standard)          │   │    │
│  │  │ DELETE /users/me│    │  - GlobalSignOut                    │   │    │
│  │  └─────────────────┘    │  - Delete DynamoDB Records          │   │    │
│  │                         │  - Delete S3 Objects                │   │    │
│  │                         │  - Delete Cognito User              │   │    │
│  │                         └─────────────────────────────────────┘   │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. コンポーネント詳細

### 2.1 クライアント

| コンポーネント | 技術 | 説明 |
|---|---|---|
| iOS App | React Native + Expo | ユーザー向けiOSアプリ |
| Android App | React Native + Expo | ユーザー向けAndroidアプリ |
| 管理画面 | React (SPA) | 運営向けWeb管理画面 |

### 2.2 AWS サービス

| サービス | 用途 | 設定 |
|---|---|---|
| **CloudFront** | CDN、管理画面ホスティング | S3オリジン、HTTPS強制 |
| **S3** | 静的ファイル保存 | 管理画面ビルド、プロフィール画像 |
| **Cognito** | 認証・認可 | ユーザープール、JWTトークン発行 |
| **API Gateway** | REST API エンドポイント | Lambda統合、Cognito Authorizer |
| **Lambda** | API処理 | Node.js 20.x、TypeScript |
| **DynamoDB** | NoSQLデータベース | オンデマンドキャパシティ、PITR有効 |
| **EventBridge** | スケジューラ | Cron式で定期実行 |
| **Step Functions** | ワークフロー | 退会処理の段階実行 |
| **CloudWatch** | ログ・メトリクス | Lambda/API Gatewayログ |

### 2.3 外部サービス

| サービス | 用途 |
|---|---|
| **Expo Push Notifications** | プッシュ通知送信 |
| **Sentry** | エラー監視・トラッキング |
| **GitHub Actions** | CI/CD |

---

## 3. 認証フロー

```
┌─────────┐          ┌─────────┐          ┌─────────┐          ┌─────────┐
│  App    │          │ Cognito │          │   API   │          │  Lambda │
└────┬────┘          └────┬────┘          └────┬────┘          └────┬────┘
     │                    │                    │                    │
     │  1. SignUp         │                    │                    │
     │───────────────────▶│                    │                    │
     │                    │                    │                    │
     │  2. Confirm (code) │                    │                    │
     │───────────────────▶│                    │                    │
     │                    │                    │                    │
     │  3. Login          │                    │                    │
     │───────────────────▶│                    │                    │
     │                    │                    │                    │
     │  4. JWT Tokens     │                    │                    │
     │◀───────────────────│                    │                    │
     │                    │                    │                    │
     │  5. API Request (Bearer Token)          │                    │
     │────────────────────────────────────────▶│                    │
     │                    │                    │                    │
     │                    │  6. Verify Token   │                    │
     │                    │◀───────────────────│                    │
     │                    │                    │                    │
     │                    │  7. Token Valid    │                    │
     │                    │───────────────────▶│                    │
     │                    │                    │                    │
     │                    │                    │  8. Invoke         │
     │                    │                    │───────────────────▶│
     │                    │                    │                    │
     │                    │                    │  9. Response       │
     │                    │                    │◀───────────────────│
     │                    │                    │                    │
     │  10. API Response                       │                    │
     │◀────────────────────────────────────────│                    │
     │                    │                    │                    │
```

---

## 4. データフロー

### 4.1 回答投稿フロー

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  App    │     │   API   │     │  Lambda │     │DynamoDB │     │ NGWords │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │               │
     │ POST /answers │               │               │               │
     │──────────────▶│               │               │               │
     │               │               │               │               │
     │               │    Invoke     │               │               │
     │               │──────────────▶│               │               │
     │               │               │               │               │
     │               │               │ 1. Check NGWords              │
     │               │               │──────────────────────────────▶│
     │               │               │                               │
     │               │               │ 2. Get DailyQuestion          │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 3. Check existing answer      │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 4. Calculate On-time/Late     │
     │               │               │               │               │
     │               │               │ 5. Save Answer │               │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │   Response    │               │               │
     │               │◀──────────────│               │               │
     │               │               │               │               │
     │   Response    │               │               │               │
     │◀──────────────│               │               │               │
     │               │               │               │               │
```

### 4.2 タイムライン取得フロー

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  App    │     │   API   │     │  Lambda │     │DynamoDB │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │ GET /timeline │               │               │
     │──────────────▶│               │               │
     │               │               │               │
     │               │    Invoke     │               │
     │               │──────────────▶│               │
     │               │               │               │
     │               │               │ 1. Get my follows             │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 2. Get my blocks              │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 3. Get users visibility       │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 4. Filter visible users       │
     │               │               │               │               │
     │               │               │ 5. Get today's answers        │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 6. Get my reactions           │
     │               │               │──────────────▶│               │
     │               │               │               │               │
     │               │               │ 7. Sort & mask NGWords        │
     │               │               │               │               │
     │               │   Response    │               │               │
     │               │◀──────────────│               │               │
     │               │               │               │               │
     │   Response    │               │               │               │
     │◀──────────────│               │               │               │
     │               │               │               │               │
```

### 4.3 質問公開フロー（定期処理）

```
┌───────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│EventBridge│     │  Lambda │     │DynamoDB │     │Expo Push│     │  App    │
└─────┬─────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
      │                │               │               │               │
      │ Trigger (cron) │               │               │               │
      │───────────────▶│               │               │               │
      │                │               │               │               │
      │                │ 1. Get DailyQuestion (今日)    │               │
      │                │──────────────▶│               │               │
      │                │               │               │               │
      │                │ 2. Get Question detail        │               │
      │                │──────────────▶│               │               │
      │                │               │               │               │
      │                │ 3. Update publishedAt         │               │
      │                │──────────────▶│               │               │
      │                │               │               │               │
      │                │ 4. Get all PushTokens         │               │
      │                │──────────────▶│               │               │
      │                │               │               │               │
      │                │ 5. Send push notifications    │               │
      │                │──────────────────────────────▶│               │
      │                │               │               │               │
      │                │               │               │  Push         │
      │                │               │               │──────────────▶│
      │                │               │               │               │
```

---

## 5. 退会処理フロー（Step Functions）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Step Functions Workflow                       │
│                    (deleteUser-{userId})                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. GlobalSignOut                                         │  │
│  │    - Cognito: AdminUserGlobalSignOut                     │  │
│  │    - 全デバイスのセッションを無効化                        │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 2. Delete Answers (with pagination)                      │  │
│  │    - DynamoDB: Query GSI1_UserHistory                    │  │
│  │    - DynamoDB: BatchWriteItem (delete)                   │  │
│  │    - Loop until all deleted                              │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 3. Delete Follows (following + followers)                │  │
│  │    - DynamoDB: Query + BatchWriteItem                    │  │
│  │    - Update follower counts                              │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 4. Delete Blocks                                         │  │
│  │    - DynamoDB: Query + BatchWriteItem                    │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 5. Delete Reactions                                      │  │
│  │    - DynamoDB: Scan + BatchWriteItem                     │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 6. Delete Profile Image                                  │  │
│  │    - S3: DeleteObject                                    │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 7. Delete PushTokens                                     │  │
│  │    - DynamoDB: Query + BatchWriteItem                    │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 8. Delete User Record                                    │  │
│  │    - DynamoDB: DeleteItem (Users table)                  │  │
│  └─────────────────────────┬────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 9. Delete Cognito User                                   │  │
│  │    - Cognito: AdminDeleteUser                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. インフラ構成（環境別）

### 6.1 環境

| 環境 | 用途 | ドメイン（例） |
|---|---|---|
| dev | 開発・テスト | api-dev.q-app.example.com |
| prod | 本番 | api.q-app.example.com |

### 6.2 リソース命名規則

```
{env}-q-{resource}

例:
- dev-q-users (DynamoDB Table)
- prod-q-api (API Gateway)
- dev-q-api-handler (Lambda Function)
```

### 6.3 CDK スタック構成

```
Q-InfraStack
├── AuthStack
│   └── Cognito User Pool
│
├── DatabaseStack
│   ├── DynamoDB Tables (11 tables)
│   └── S3 Bucket (profile images)
│
├── ApiStack
│   ├── API Gateway
│   ├── Lambda Functions
│   └── Cognito Authorizer
│
├── SchedulerStack
│   ├── EventBridge Rules
│   └── Lambda Functions
│
├── WorkflowStack
│   └── Step Functions (退会処理)
│
├── FrontendStack
│   ├── S3 Bucket (管理画面)
│   └── CloudFront Distribution
│
└── MonitoringStack
    ├── CloudWatch Alarms
    └── Sentry Integration
```

---

## 7. セキュリティ

### 7.1 認証・認可

| レイヤー | 方式 |
|---|---|
| ユーザー認証 | Cognito JWT |
| API認可 | API Gateway Cognito Authorizer |
| 管理画面認証 | IAM + Cognito Identity |

### 7.2 通信

| 区間 | 暗号化 |
|---|---|
| クライアント ↔ CloudFront | HTTPS (TLS 1.2+) |
| CloudFront ↔ API Gateway | HTTPS |
| Lambda ↔ DynamoDB | AWS内部通信（暗号化） |

### 7.3 データ保護

| 対象 | 方式 |
|---|---|
| DynamoDB | 保存時暗号化（AWS管理キー） |
| S3 | SSE-S3（サーバーサイド暗号化） |
| Cognito | パスワードはハッシュ化保存 |

---

## 8. 監視・ログ

### 8.1 CloudWatch

| 対象 | メトリクス |
|---|---|
| API Gateway | リクエスト数、レイテンシ、4xx/5xxエラー |
| Lambda | 実行時間、エラー数、同時実行数 |
| DynamoDB | 読み書きキャパシティ、スロットリング |

### 8.2 アラート（本番環境）

| 条件 | アクション |
|---|---|
| API 5xxエラー率 > 1% | 通知（Slack/メール） |
| Lambda エラー > 10/分 | 通知 |
| Step Functions 失敗 | 通知 |

### 8.3 Sentry

| 対象 | 設定 |
|---|---|
| モバイルアプリ | sentry-expo でクラッシュ・エラー追跡 |
| Lambda | Sentry SDK でエラー追跡 |

---

## 9. コスト見積もり（月額・目安）

### 小規模（〜1,000 DAU）

| サービス | 見積もり |
|---|---|
| API Gateway | $5〜10 |
| Lambda | $1〜5 |
| DynamoDB | $5〜15 |
| S3 | $1〜5 |
| CloudFront | $1〜5 |
| Cognito | $0（5万MAUまで無料） |
| **合計** | **$15〜40/月** |

※ 実際のコストは利用量により変動

---

## 10. 可用性・スケーラビリティ

| コンポーネント | 可用性 | スケーラビリティ |
|---|---|---|
| API Gateway | マネージド（高可用性） | 自動スケール |
| Lambda | マネージド（高可用性） | 自動スケール（同時実行上限あり） |
| DynamoDB | マルチAZ | オンデマンドで自動スケール |
| S3 | 99.999999999% 耐久性 | 無制限 |
| CloudFront | グローバルエッジ | 自動スケール |
