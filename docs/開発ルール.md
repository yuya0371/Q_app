# 開発ルール

本プロジェクトの開発における運用ルールです。過去のトラブル経験を元に制定しています。

---

## 1. API設計・実装の同期

### ルール
- **API設計書を変更したら、フロントエンド/バックエンド両方の実装を確認・更新する**
- **実装を変更したら、API設計書も更新する**

### チェックリスト
- [ ] HTTPメソッド（GET/POST/PUT/PATCH/DELETE）は一致しているか
- [ ] パスパラメータ・クエリパラメータは一致しているか
- [ ] リクエスト/レスポンスのフィールド名は一致しているか
- [ ] 設計書の更新履歴に追記したか

### 背景
HTTPメソッドの不一致（フロント: PATCH、バックエンド: PUT）で403エラーが発生した。

---

## 2. API Gateway CDK開発

### ルール
- **固定パスは変数パスより先に定義する**
- **新しいエンドポイント追加時は、既存のルート定義順序を確認する**

### 正しい例
```typescript
// 固定パス 'me' を先に定義
const meResource = usersResource.addResource('me');
meResource.addMethod('PUT', ...);

// 変数パス '{userId}' を後に定義
const userByIdResource = usersResource.addResource('{userId}');
userByIdResource.addMethod('GET', ...);
```

### 背景
`/users/{userId}`を`/users/me`より先に定義したため、`/users/me`へのリクエストが`userId=me`として解釈され403エラーが発生した。

---

## 3. Cognito認証

### ルール
- **API GatewayのCognitoUserPoolsAuthorizerにはID Tokenを使用する**
- **Access TokenはLambda内での認可チェック等に使用可能（現状未使用）**

### トークンの使い分け
| トークン | 用途 |
|---------|------|
| ID Token | API Gateway認証、ユーザー属性取得 |
| Access Token | スコープベースの認可（現状未使用） |
| Refresh Token | トークンのリフレッシュ |

### 背景
Access Tokenを送信していたため、API Gatewayで401 Unauthorizedが発生した。

---

## 4. React Native ストレージ

### ルール
- **JWTトークン等のサイズが大きいデータはAsyncStorageを使用する**
- **SecureStoreは2048バイト以下の機密データに使用する**

### ストレージの使い分け
| ストレージ | サイズ制限 | 用途 |
|-----------|-----------|------|
| SecureStore | 2048バイト | APIキー、短い機密情報 |
| AsyncStorage | 制限なし | JWTトークン、キャッシュデータ |

### 背景
SecureStoreの2048バイト制限により、JWTトークンが正しく保存できなかった。

---

## 5. TODOコメント管理

### ルール
- **TODOコメントを残す場合は、対応するタスク管理表のタスク番号を記載する**
- **リリース前にTODOコメントを検索し、全て解消する**

### 正しい例
```typescript
// TODO: タスク4-22で実装予定 - ユーザー検索API呼び出し
await new Promise((resolve) => setTimeout(resolve, 500));
```

### TODOチェックコマンド
```bash
grep -r "TODO" apps/mobile/src --include="*.ts" --include="*.tsx"
```

### 背景
App ID設定のTODOが放置され、ダミー処理のままリリース前テストに進んでしまった。

---

## 6. デプロイ前チェックリスト

### CDKデプロイ前
- [ ] TypeScriptのコンパイルエラーがないか（`npm run build`）
- [ ] Lambda関数の環境変数は正しいか
- [ ] API Gatewayのルート定義順序は正しいか

### モバイルアプリテスト前
- [ ] TODOコメントが残っていないか
- [ ] デバッグ用のconsole.logを削除したか（または本番ビルドで除外されるか）
- [ ] APIのエンドポイント・メソッドは設計書と一致しているか

---

## 7. トラブル発生時の対応

### 手順
1. **ログを確認**
   - フロントエンド: Metro Bundlerのコンソール
   - バックエンド: CloudWatch Logs

2. **問題を切り分け**
   - Lambdaに到達している → Lambda内部の問題
   - Lambdaに到達していない → API Gateway/Authorizerの問題

3. **解決後、ドキュメントに追記**
   - `docs/開発トラブルシューティング.md` に記録

---

## 8. 実装後の設計書同期（必須）

### ルール
- **実装作業が完了したら、必ず設計書との整合性を確認し、設計書を更新する**
- **実装を正とし、設計書を実装に合わせる**（逆ではない）
- **変更理由を必ず明記する**

### 対象ドキュメント
| ドキュメント | 確認内容 |
|-------------|----------|
| API設計書.md | エンドポイント、HTTPメソッド、リクエスト/レスポンス形式 |
| DB設計書.md | テーブル構造、GSI、属性名 |
| 画面設計書.md | 画面構成、画面遷移 |

### チェックリスト
- [ ] 新規追加したエンドポイントは設計書に記載したか
- [ ] 変更したHTTPメソッド/パスは設計書を更新したか
- [ ] 未実装の機能は「❌ TODO」マークを付けたか
- [ ] 変更理由（※注釈）を追記したか
- [ ] 更新履歴に日付と内容を追記したか

### 記載例
```markdown
| メソッド | エンドポイント | 説明 | 実装状況 |
|---|---|---|---|
| PUT | /users/me | プロフィール更新 | ✅ ※1 |
| GET | /users/me/check-app-id | アプリ内ID重複チェック | ❌ TODO |

> **変更理由:**
> - ※1: PATCH → PUT に変更（API Gatewayの定義に合わせる）
```

### 背景
実装とドキュメントの乖離により、以下の問題が発生した：
- DynamoDB GSI名の不一致（`followingId-index` vs `GSI1_Followers`）
- 属性名の不一致（`followingId` vs `followeeId`）
- APIレスポンス形式の不一致（`{ users }` vs `{ items }`）

設計書が古いまま放置されると、新規開発者の混乱やバグの原因となる。

---

## 9. トラブルシューティングドキュメント更新（必須）

### ルール
- **開発中に発生した問題と解決方法は、必ず `docs/開発トラブルシューティング.md` に追記する**
- **同じ問題を二度調査しないために、詳細に記録する**

### 記載フォーマット
```markdown
## N. タイトル

### 発生日
YYYY-MM-DD

### 症状
- 具体的な症状を箇条書きで

### エラーメッセージ
（あれば）

### 原因
なぜこの問題が発生したか

### 解決方法
具体的なコード修正内容

### 教訓
今後同様の問題を防ぐための知見
```

---

## 10. 要件定義書との照合（必須）

### ルール
- **新機能の実装前に、必ず要件定義書の該当セクションを読む**
- **実装完了後に、要件定義書との差分がないか確認する**
- **フェーズ完了時に、要件定義書との突き合わせを行う**

### チェックリスト（実装前）
- [ ] 要件定義書の該当セクションを読んだか
- [ ] DB設計書で関連するテーブル・フィールドを確認したか
- [ ] 実装方法が要件を満たすか検討したか

### チェックリスト（実装後）
- [ ] 要件定義書の仕様通りに実装されているか
- [ ] DB設計書に定義されているフィールドは全て使用されているか
- [ ] UIの文言は要件定義書と一致しているか

### チェックリスト（フェーズ完了時）
- [ ] 該当フェーズのタスク一覧を確認したか
- [ ] 各タスクが要件定義書の仕様を満たしているか
- [ ] 設計書（DB/API）と実装の整合性を確認したか

### 背景
質問公開機能で、要件定義書には「毎日10:00〜21:00の間でランダム」と明記されていたのに、固定時刻（7:00 JST）で実装されていた。DB設計書には `scheduledPublishTime` フィールドが定義されていたが、実装時に参照されず、フィールドが使われていなかった。

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-05 | 初版作成 |
| 2026-02-05 | #8 実装後の設計書同期、#9 トラブルシューティングドキュメント更新を追加 |
| 2026-02-05 | #10 要件定義書との照合を追加（質問公開時刻の仕様乖離を受けて） |
