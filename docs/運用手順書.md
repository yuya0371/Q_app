# 運用手順書 -- Q.

## 更新履歴

| 日付 | 内容 |
|---|---|
| 2026-02-09 | 初版作成 |

---

## 1. 概要

本書は Q. アプリの日常運用に必要な手順をまとめたものである。運営チームが管理画面およびAWSコンソールを通じて実施する業務を対象とする。

### 1.1 システム構成

| コンポーネント | サービス | 用途 |
|---|---|---|
| 認証 | Amazon Cognito | ユーザー認証・セッション管理 |
| API | API Gateway + Lambda | REST API（Node.js / TypeScript） |
| データベース | DynamoDB | 12テーブル（オンデマンドモード） |
| ストレージ | S3 | プロフィール画像 |
| 定期処理 | EventBridge + Lambda | お題スケジュール・公開処理 |
| 退会処理 | Step Functions (Standard) | ユーザーデータ段階削除 |
| 通知 | Expo Push Notifications | プッシュ通知 |
| 監視 | Sentry + CloudWatch | エラー監視・ログ |
| 管理画面 | React (Web) | 運営操作 |

### 1.2 環境

| 環境 | スタック名プレフィックス | 用途 |
|---|---|---|
| dev | `dev-q-` | 開発・テスト用 |
| prod | `prod-q-` | 本番環境 |

### 1.3 リージョン

全リソースは `ap-northeast-1`（東京）に配置。

---

## 2. お題管理

### 2.1 運営お題の追加

管理画面から運営お題を追加する。

**手順:**
1. 管理画面にログインする
2. 「お題管理」画面を開く
3. 「運営お題追加」ボタンを押す
4. お題本文を入力する（最大80文字、改行可、URL禁止）
5. 追加ボタンを押す

**API:** `POST /admin/questions`

```json
{
  "text": "お題本文"
}
```

**注意事項:**
- 100問以上のストックを維持すること（フォールバック用バックアップ）
- 直近30日と重複しないよう留意する
- お題は `approved` ステータスで作成され、即座に採用候補となる

### 2.2 運営お題の確認

**手順:**
1. 管理画面の「お題管理」画面を開く
2. ステータスフィルタで一覧を確認する

**API:** `GET /admin/questions`

**ステータス一覧:**

| status | 説明 |
|---|---|
| `pending` | 審査待ち（ユーザー投稿） |
| `approved` | 承認済み（採用候補） |
| `rejected` | 却下 |
| `used` | 使用済み（直近30日以内に出題） |
| `archived` | アーカイブ（無効化） |

### 2.3 ユーザー提案お題の承認/却下

ユーザーから提案されたお題を審査する。

**手順:**
1. 管理画面の「提案お題」画面を開く
2. 審査待ち（`pending`）のお題一覧を確認する
3. 各お題の内容を確認し、承認または却下を選択する
4. NGワード検知（`isFlagged`）されたお題は特に注意して審査する

**API:** `PUT /admin/submissions/{submissionId}`

```json
{
  "status": "approved"
}
```
or
```json
{
  "status": "rejected"
}
```

**注意事項:**
- ユーザーには承認/却下の結果は通知されない（仕様）
- 却下理由もユーザーには返さない
- 承認済みお題はランダムに採用される
- 在庫不足時は運営お題に自動切替される

### 2.4 今日のお題の手動設定

通常は自動スケジュールで運用されるが、手動で設定することも可能。

**API:** `POST /admin/daily-question`

```json
{
  "questionId": "対象お題のID",
  "date": "2026-02-10"
}
```

### 2.5 お題自動スケジュールの仕組み

以下の2つの定期処理で自動運用される。

| 処理 | Lambda関数名 | スケジュール | 内容 |
|---|---|---|---|
| お題選択 | `{prefix}-scheduled-schedule-daily-question` | 毎日 00:00 JST | 翌日の質問を選択し、10:00-21:00のランダム公開時刻を決定 |
| 公開チェック | `{prefix}-scheduled-check-and-publish` | 10分おき（10:00-21:00 JST） | 公開時刻に達していれば質問を公開し、プッシュ通知を送信 |

**お題選択ロジック:**
1. 承認済みユーザーお題からランダムに選択（優先）
2. 直近30日に使用されたお題は除外
3. ユーザーお題の在庫不足時は運営お題に切替
4. 全お題なし時はフォールバックお題を使用

---

## 3. 通報対応

### 3.1 方針

- 通報受領後 **24時間以内** に対応方針を決定する
- 通報カテゴリ: スパム / 嫌がらせ・いじめ / 不適切なコンテンツ / なりすまし / 個人情報の公開 / その他

### 3.2 通報一覧の確認

**手順:**
1. 管理画面の「通報管理」画面を開く
2. ステータス `pending` の通報を確認する
3. 対象ユーザーまたは投稿の内容を確認する

**API:** `GET /admin/reports`

### 3.3 通報の対応

**手順:**
1. 通報内容と対象を確認する
2. 対応方針を決定する（下記参照）
3. 必要に応じてユーザーBAN等の措置を実施する
4. 通報ステータスを更新する

**API:** `PUT /admin/reports/{reportId}`

```json
{
  "status": "resolved",
  "note": "対応内容のメモ"
}
```

**通報ステータス:**

| status | 説明 |
|---|---|
| `pending` | 未対応 |
| `resolved` | 対応完了 |
| `dismissed` | 却下（問題なし） |

### 3.4 対応方針の判断基準

| 通報カテゴリ | 対応例 |
|---|---|
| スパム | ユーザーBAN |
| 嫌がらせ・いじめ | 内容確認後、必要に応じてBAN |
| 不適切なコンテンツ | NGワード追加 + 必要に応じてBAN |
| なりすまし | 調査後、該当ユーザーBAN |
| 個人情報の公開 | 即座に対応、必要に応じてBAN |
| その他 | 個別判断 |

---

## 4. ユーザーBAN/BAN解除

### 4.1 ユーザーBAN

BANされたユーザーはログイン不可となり、既存セッションも強制ログアウトされる。

**手順:**
1. 管理画面の「ユーザー管理」画面を開く
2. 対象ユーザーを検索する
3. ユーザー詳細を確認する
4. 「BAN」ボタンを押す
5. 確認後、実行する

**API:** `POST /admin/users/{userId}/ban`

**BAN時の挙動:**
- `isBanned` フラグが `true` に設定される
- 以後のログイン試行は `ACCOUNT_BANNED` エラーで拒否される
- 既存セッションでのAPI呼び出しも拒否される

### 4.2 BAN解除

**手順:**
1. 管理画面の「ユーザー管理」画面を開く
2. 対象ユーザーを検索する
3. 「BAN解除」ボタンを押す
4. 確認後、実行する

**API:** `DELETE /admin/users/{userId}/ban`

---

## 5. NGワード管理

### 5.1 概要

NGワードは投稿を弾くのではなく、**表示時に本人含めてマスク（`*`）する**仕組み。NGワード検知された投稿は `isFlagged` フラグが付けられ、運営が後から確認できる。

### 5.2 NGワード追加

**手順:**
1. 管理画面の「NGワード管理」画面を開く
2. 追加するNGワードを入力する
3. 追加ボタンを押す

**API:** `POST /admin/ng-words`

```json
{
  "word": "NGワード"
}
```

**注意事項:**
- NGワードは小文字に正規化されて保存される
- 追加後、新規投稿に即座に適用される
- 既存投稿のマスク処理は表示時に動的に行われる

### 5.3 NGワード削除

**API:** `DELETE /admin/ng-words/{word}`

- `{word}` はURLエンコードされたNGワード文字列（日本語対応）

### 5.4 NGワード一覧確認

**API:** `GET /admin/ng-words`

---

## 6. フラグ付き投稿の確認

### 6.1 概要

NGワードが検知された投稿（`isFlagged: true`）を一覧で確認し、対応する。

### 6.2 確認手順

**手順:**
1. 管理画面の「フラグ付き投稿」画面を開く
2. フラグ付き投稿の一覧を確認する
3. 必要に応じて対応する（投稿者のBAN等）

**API:**
- 一覧取得: `GET /admin/flagged-posts`
- 対応更新: `PUT /admin/flagged-posts/{answerId}`

---

## 7. 退会処理の監視

### 7.1 概要

退会処理は Step Functions（Standard）で段階的に実行される。

**ステートマシン名:** `{prefix}-delete-user`

**処理フロー:**
1. **DeleteUserData** -- DynamoDBからユーザーデータを削除（Users, Answers, Reactions, Follows, Blocks, PushTokens）
2. **DeleteUserImages** -- S3からプロフィール画像を削除
3. **DeleteCognitoUser** -- Cognitoユーザーを削除（AdminUserGlobalSignOut -> AdminDeleteUser）

### 7.2 実行状況の確認

**AWSコンソールでの確認手順:**
1. AWS Step Functions コンソールを開く
2. ステートマシン `{prefix}-delete-user` を選択する
3. 実行一覧で各実行のステータスを確認する
   - `RUNNING` -- 実行中
   - `SUCCEEDED` -- 完了
   - `FAILED` -- 失敗
   - `TIMED_OUT` -- タイムアウト（1時間で設定）

### 7.3 失敗時の対応

失敗した場合は **redrive**（途中から再開）で対応する。

**redrive手順:**
1. Step Functions コンソールで失敗した実行を開く
2. 失敗したステップを確認する
3. エラー内容をCloudWatchログで確認する
4. 「Redrive」ボタンを押して失敗ステップから再実行する

**二重実行防止:**
- 実行名は `deleteUser-{userId}` 形式で固定されている
- 同一ユーザーの二重起動は自動的に防止される

### 7.4 手動での退会データ削除

Step Functions の redrive でも解決しない場合は、手動対応が必要。

**手順:**
1. 失敗したステップを特定する
2. 対象ユーザーIDを確認する
3. 以下のテーブルから手動でデータを削除する:
   - `{prefix}-users` (PK: userId)
   - `{prefix}-answers` (GSI1_UserHistory: userId)
   - `{prefix}-reactions` (reactorIdが該当するレコード)
   - `{prefix}-follows` (followerId or followeeIdが該当するレコード)
   - `{prefix}-blocks` (blockerId or blockedIdが該当するレコード)
   - `{prefix}-push-tokens` (PK: userId)
4. S3バケット `{prefix}-profile-images-{accountId}` からプロフィール画像を削除する
5. Cognito コンソールからユーザーを削除する

---

## 8. CloudWatchログ確認

### 8.1 Lambda関数のログ確認

各Lambda関数のログは CloudWatch Logs に出力される。

**ログ確認コマンド:**

```bash
# 直近10分のログを確認
aws logs tail /aws/lambda/{prefix}-{function-name} --since 10m --format short

# 特定の文字列でフィルタ
aws logs tail /aws/lambda/{prefix}-{function-name} --since 1h --filter-pattern "ERROR"
```

### 8.2 主要Lambda関数名一覧

**認証系:**
| 関数名 | 用途 |
|---|---|
| `{prefix}-auth-signup` | ユーザー登録 |
| `{prefix}-auth-confirm` | メール確認 |
| `{prefix}-auth-login` | ログイン |
| `{prefix}-auth-refresh` | トークンリフレッシュ |
| `{prefix}-auth-forgot-password` | パスワードリセット開始 |
| `{prefix}-auth-reset-password` | パスワードリセット実行 |

**ユーザー系:**
| 関数名 | 用途 |
|---|---|
| `{prefix}-users-get-profile` | プロフィール取得 |
| `{prefix}-users-update-profile` | プロフィール更新 |
| `{prefix}-users-set-app-id` | アプリ内ID設定 |
| `{prefix}-users-search` | ユーザー検索 |
| `{prefix}-users-delete-account` | 退会処理開始 |

**お題・回答系:**
| 関数名 | 用途 |
|---|---|
| `{prefix}-questions-get-daily` | 今日の質問取得 |
| `{prefix}-answers-create` | 回答投稿 |
| `{prefix}-answers-delete` | 回答削除 |
| `{prefix}-answers-timeline` | タイムライン取得 |

**定期処理:**
| 関数名 | 用途 |
|---|---|
| `{prefix}-scheduled-schedule-daily-question` | お題スケジュール（0:00 JST） |
| `{prefix}-scheduled-check-and-publish` | 公開チェック（10分おき） |

**退会ワークフロー:**
| 関数名 | 用途 |
|---|---|
| `{prefix}-workflow-delete-user-data` | DynamoDBデータ削除 |
| `{prefix}-workflow-delete-user-images` | S3画像削除 |
| `{prefix}-workflow-delete-cognito-user` | Cognitoユーザー削除 |

**管理系:**
| 関数名 | 用途 |
|---|---|
| `{prefix}-admin-list-ng-words` | NGワード一覧 |
| `{prefix}-admin-add-ng-word` | NGワード追加 |
| `{prefix}-admin-delete-ng-word` | NGワード削除 |
| `{prefix}-admin-ban-user` | ユーザーBAN |
| `{prefix}-admin-unban-user` | BAN解除 |
| `{prefix}-admin-list-reports` | 通報一覧 |
| `{prefix}-admin-update-report` | 通報更新 |
| `{prefix}-admin-list-flagged-posts` | フラグ投稿一覧 |
| `{prefix}-admin-review-flagged-post` | フラグ投稿対応 |

### 8.3 CloudWatchコンソールでの確認

1. CloudWatch コンソールを開く
2. 「ログ」>「ロググループ」を選択する
3. `/aws/lambda/{prefix}-` でフィルタする
4. 対象のロググループを選択してログストリームを確認する

### 8.4 Sentryでのエラー確認

Lambda関数とモバイルアプリのエラーは Sentry にも送信される。
Sentryダッシュボードで未解決のエラーを定期的に確認すること。

---

## 9. CDKデプロイ

### 9.1 デプロイ手順

```bash
cd infra && npx cdk deploy --all --require-approval never
```

### 9.2 特定スタックのみデプロイ

```bash
# 例: APIスタックのみ
cd infra && npx cdk deploy dev-q-api --require-approval never

# 例: データベーススタックのみ
cd infra && npx cdk deploy dev-q-database --require-approval never
```

### 9.3 スタック一覧

| スタック名 | 内容 |
|---|---|
| `{prefix}-auth` | Cognito（User Pool, Client） |
| `{prefix}-database` | DynamoDB（12テーブル） |
| `{prefix}-storage` | S3（プロフィール画像バケット） |
| `{prefix}-workflow` | Step Functions（退会処理） |
| `{prefix}-api` | API Gateway + Lambda関数群 |
| `{prefix}-scheduler` | EventBridge + 定期処理Lambda |

### 9.4 デプロイ前の確認

```bash
# 差分確認
cd infra && npx cdk diff --all

# シンセサイズ（テンプレート生成のみ）
cd infra && npx cdk synth --all
```

### 9.5 本番デプロイ時の注意

- 本番環境へのデプロイは必ず `cdk diff` で変更内容を確認してから実施する
- DynamoDBテーブルの `removalPolicy` は `RETAIN` に設定されているため、スタック削除時もデータは保持される
- テーブルのキー変更やGSI追加はダウンタイムが発生する可能性がある

---

## 10. 監査ログ

### 10.1 概要

管理者の全操作は `AdminLogs` テーブルに自動記録される。TTLにより90日後に自動削除される。

### 10.2 記録されるアクション

| アクション | 説明 |
|---|---|
| `ADD_NG_WORD` | NGワード追加 |
| `DELETE_NG_WORD` | NGワード削除 |
| `CREATE_QUESTION` | お題作成 |
| `SET_DAILY_QUESTION` | 今日のお題設定 |
| `UPDATE_REPORT` | 通報ステータス更新 |
| `REVIEW_SUBMISSION` | 提案お題の承認/却下 |
| `BAN_USER` | ユーザーBAN |
| `UNBAN_USER` | BAN解除 |
| `REVIEW_FLAGGED_POST` | フラグ付き投稿の対応 |

### 10.3 監査ログの確認

**管理画面から:** 「監査ログ」画面で一覧確認

**API:** `GET /admin/logs`

**DynamoDBから直接確認:**
- テーブル: `{prefix}-admin-logs`
- PK: `LOG`（固定値）
- SK: `{timestamp}#{logId}`（時系列順）

---

## 11. DynamoDBテーブル一覧

| # | テーブル名 | PK | SK | 用途 |
|---|---|---|---|---|
| 1 | `{prefix}-users` | userId | - | ユーザー情報 |
| 2 | `{prefix}-daily-questions` | date | - | 日別お題 |
| 3 | `{prefix}-questions` | questionId | - | お題マスタ |
| 4 | `{prefix}-answers` | date | userId | 回答 |
| 5 | `{prefix}-follows` | followerId | followeeId | フォロー関係 |
| 6 | `{prefix}-blocks` | blockerId | blockedId | ブロック関係 |
| 7 | `{prefix}-reactions` | answerId | reactorId | リアクション |
| 8 | `{prefix}-reports` | reportId | - | 通報 |
| 9 | `{prefix}-user-question-submissions` | date | userId | お題提出履歴 |
| 10 | `{prefix}-ng-words` | word | - | NGワード |
| 11 | `{prefix}-push-tokens` | userId | token | プッシュトークン |
| 12 | `{prefix}-admin-logs` | pk (`LOG`) | sk (`timestamp#logId`) | 監査ログ |

全テーブルで PITR（Point-in-Time Recovery）が有効。

---

## 12. 日常運用チェックリスト

### 毎日

- [ ] 未対応通報の確認（24時間以内対応）
- [ ] フラグ付き投稿の確認
- [ ] ユーザー提案お題の審査
- [ ] 今日のお題が正常に公開されたか確認
- [ ] Sentry未解決エラーの確認

### 毎週

- [ ] お題ストック数の確認（承認済みお題が十分にあるか）
- [ ] 退会処理の実行状況確認（失敗がないか）
- [ ] CloudWatchのエラー率確認

### 毎月

- [ ] 運営お題の在庫補充（100問以上を維持）
- [ ] NGワードリストの見直し
- [ ] 監査ログの確認（不正操作がないか）
- [ ] DynamoDBのキャパシティ確認（オンデマンドのコスト確認）

---

## 13. 運用担当者の権限

### 13.1 AWSコンソール権限

運営担当者には最小権限を付与する。MFA必須。

| 権限 | 対象リソース | 用途 |
|---|---|---|
| Step Functions: 実行確認・redrive | `{prefix}-delete-user` | 退会処理の監視・復旧 |
| CloudWatch Logs: 読み取り | `/aws/lambda/{prefix}-*` | ログ確認 |
| DynamoDB: 読み取り | `{prefix}-*` | データ確認（緊急時） |

### 13.2 管理画面権限

- 管理者は全員同じ権限（MVPでは権限レベルを分けない）
- Cognito ID Token で認証し、`isAdmin` フラグで管理者判定
- 管理画面APIは全て `/admin` プレフィックス配下

---

## 14. S3バケット管理

### 14.1 プロフィール画像バケット

- **バケット名:** `{prefix}-profile-images-{accountId}`
- **公開設定:** パブリック読み取り可能
- **暗号化:** S3マネージド暗号化
- **CORS:** 全オリジン許可（PUT/GET/POST）
- **ライフサイクル:** 不完全なマルチパートアップロードは7日後に自動削除

### 14.2 画像アップロードフロー

1. クライアントが `POST /users/me/profile-image` でPresigned URLを取得
2. クライアントがPresigned URLに対してPUTリクエストで画像をアップロード
3. Presigned URLの有効期限は5分

---

## 15. Cognito管理

### 15.1 User Pool設定

- **User Pool名:** `{prefix}-users`
- **サインイン:** メールアドレス（alias）
- **パスワードポリシー:** 最小8文字、複雑性要件なし
- **トークン有効期限:**
  - アクセストークン: 1時間
  - IDトークン: 1時間
  - リフレッシュトークン: 30日
- **アカウント回復:** メールのみ

### 15.2 ユーザー確認

AWSコンソールの Cognito > User Pools > `{prefix}-users` からユーザーの確認・管理が可能。

---

## 16. EventBridgeルール一覧

| ルール名 | スケジュール | Lambda関数 | 説明 |
|---|---|---|---|
| `{prefix}-schedule-daily-question` | 毎日 15:00 UTC (00:00 JST) | `{prefix}-scheduled-schedule-daily-question` | 翌日のお題選択・公開時刻決定 |
| `{prefix}-check-and-publish` | 10分おき 01:00-12:00 UTC (10:00-21:00 JST) | `{prefix}-scheduled-check-and-publish` | お題公開チェック・プッシュ通知送信 |
