# 障害対応マニュアル -- Q.

## 更新履歴

| 日付 | 内容 |
|---|---|
| 2026-02-09 | 初版作成 |

---

## 1. 障害レベル定義

| レベル | 名称 | 定義 | 対応目標 | 例 |
|---|---|---|---|---|
| **P1** | Critical | サービス全体が停止、全ユーザーに影響 | 即時対応（15分以内に着手） | API Gateway障害、Cognito障害、DynamoDB全体障害 |
| **P2** | Major | 主要機能が利用不可、多数のユーザーに影響 | 1時間以内に着手 | お題公開失敗、タイムライン取得不可、認証エラー多発 |
| **P3** | Minor | 一部機能が利用不可、少数のユーザーに影響 | 24時間以内に着手 | 特定ユーザーの退会処理失敗、プッシュ通知未送信、リアクション操作不可 |
| **P4** | Low | 軽微な問題、ユーザー影響が限定的 | 次の営業日以内 | 管理画面の表示崩れ、監査ログ記録漏れ |

---

## 2. エスカレーションフロー

### 2.1 連絡体制

```
障害検知
  |
  v
一次対応（運営担当者）
  |-- 状況確認・影響範囲特定
  |-- P3/P4 → 自チームで対応
  |
  v（P1/P2の場合）
二次対応（開発リード）
  |-- 技術的調査・対応
  |-- 必要に応じてAWSサポートへ連絡
  |
  v（P1で解決困難な場合）
三次対応（プロジェクト責任者）
  |-- 対外対応判断
  |-- リソース調整
```

### 2.2 エスカレーション条件

| 条件 | エスカレーション先 |
|---|---|
| P1障害検知 | 即座に開発リードへ連絡 |
| P2障害が30分以内に解決しない | 開発リードへ連絡 |
| P1障害が1時間以内に解決しない | プロジェクト責任者へ連絡 |
| AWSサービス障害の疑い | AWSサポートケース作成 |

### 2.3 連絡時に伝える情報

1. **障害レベル**（P1-P4）
2. **発生時刻**
3. **影響範囲**（全ユーザー / 一部ユーザー / 管理者のみ）
4. **症状**（何が起きているか）
5. **確認済みの内容**（CloudWatch/Sentryの情報等）
6. **暫定対応の有無**

---

## 3. 障害検知方法

### 3.1 Sentryアラート

Lambda関数とモバイルアプリのエラーは Sentry に送信される。

**確認方法:**
- Sentryダッシュボードにアクセスする
- 「Issues」タブで未解決のエラーを確認する
- エラー発生頻度の急増は障害の兆候

### 3.2 CloudWatch Logs

**Lambda関数のエラー確認:**

```bash
# 直近10分のエラーログ
aws logs tail /aws/lambda/{prefix}-{function-name} --since 10m --filter-pattern "ERROR" --format short

# 特定のエラーコードで検索
aws logs tail /aws/lambda/{prefix}-{function-name} --since 1h --filter-pattern "INTERNAL_ERROR" --format short
```

**主要なロググループ:**
- `/aws/lambda/{prefix}-auth-*` -- 認証系
- `/aws/lambda/{prefix}-users-*` -- ユーザー系
- `/aws/lambda/{prefix}-answers-*` -- 回答系
- `/aws/lambda/{prefix}-questions-*` -- お題系
- `/aws/lambda/{prefix}-scheduled-*` -- 定期処理
- `/aws/lambda/{prefix}-workflow-*` -- 退会ワークフロー
- `/aws/lambda/{prefix}-admin-*` -- 管理系

### 3.3 API Gatewayメトリクス

CloudWatch の API Gateway メトリクスで以下を監視する:
- **5XXError**: サーバーエラー数
- **4XXError**: クライアントエラー数（急増は異常の兆候）
- **Latency**: レスポンス時間
- **Count**: リクエスト数

### 3.4 Step Functions

**AWSコンソールでの確認:**
1. Step Functions コンソールを開く
2. ステートマシン `{prefix}-delete-user` を選択する
3. `FAILED` / `TIMED_OUT` の実行がないか確認する

---

## 4. 主要障害パターンと対応手順

### 4.1 お題が公開されない

**症状:** 10:00-21:00 JSTの間にお題が公開されない

**確認手順:**
1. DailyQuestionsテーブルで当日のレコードを確認する
   ```bash
   aws dynamodb get-item --table-name {prefix}-daily-questions --key '{"date":{"S":"2026-02-09"}}'
   ```
2. `scheduledPublishTime` と `publishedAt` を確認する
3. `publishedAt` が未設定の場合、公開処理が実行されていない

**原因別対応:**

| 原因 | 対応 |
|---|---|
| DailyQuestionsに当日レコードがない | お題スケジュールLambdaが失敗。手動でお題を設定する（`POST /admin/daily-question`） |
| レコードはあるが `publishedAt` がない | check-and-publish Lambdaが失敗。CloudWatchログを確認し、手動でLambdaを実行する |
| EventBridgeルールが無効化されている | AWSコンソールでルールを有効化する |
| お題ストック切れ | フォールバックお題が自動適用されるはず。ログでフォールバック動作を確認する |

**フォールバック確認:**
- DailyQuestionsレコードの `isFallback` が `true` の場合、フォールバックお題が使用されている
- フォールバックお題が発動した事実はユーザーには表示されない（仕様通り）

**手動でのお題公開:**
```bash
# 管理画面APIで今日のお題を設定
curl -X POST https://api.{domain}/v1/admin/daily-question \
  -H "Authorization: Bearer {admin_token}" \
  -H "Content-Type: application/json" \
  -d '{"questionId": "{question_id}", "date": "2026-02-09"}'
```

### 4.2 認証エラーが多発

**症状:** ログインや認証付きAPI呼び出しが失敗する

**確認手順:**
1. Sentry/CloudWatchでエラー内容を確認する
2. Cognitoサービスの状態を確認する（AWS Health Dashboard）
3. Lambda関数のログでエラーを確認する

**原因別対応:**

| 原因 | 対応 |
|---|---|
| Cognito障害 | AWS Health Dashboardを確認。復旧を待つ |
| User Pool Client設定変更 | CDKの auth-stack.ts を確認し、再デプロイする |
| トークン有効期限切れ | アクセストークンは1時間、リフレッシュトークンは30日。正常な動作の可能性 |
| 環境変数の不整合 | `USER_POOL_ID`, `USER_POOL_CLIENT_ID` がLambda環境変数で正しく設定されているか確認する |

### 4.3 タイムライン取得の遅延・失敗

**症状:** タイムラインの読み込みが遅い、またはエラーが返る

**確認手順:**
1. `{prefix}-answers-timeline` Lambdaのログを確認する
2. DynamoDBのスロットリングが発生していないか確認する

**原因別対応:**

| 原因 | 対応 |
|---|---|
| DynamoDBスロットリング | オンデマンドモードのため自動スケール。一時的な場合は待機 |
| Lambda タイムアウト（30秒） | フォロー数が多いユーザーで発生する可能性。ログで確認 |
| ブロック判定のN+1問題 | 多数のフォローがある場合に遅延。将来のキャッシュ導入を検討 |

### 4.4 退会処理（Step Functions）の失敗

**症状:** Step Functions実行が `FAILED` ステータスになる

**確認手順:**
1. Step Functions コンソールで失敗した実行を開く
2. 失敗したステップ（DeleteUserData / DeleteUserImages / DeleteCognitoUser）を特定する
3. そのステップのLambdaのCloudWatchログを確認する

**Redrive手順:**
1. Step Functions コンソールで失敗した実行を選択する
2. 「Redrive」ボタンをクリックする
3. 失敗したステップから再実行が開始される
4. 実行結果が `SUCCEEDED` になることを確認する

**各ステップの失敗原因と対応:**

| ステップ | よくある原因 | 対応 |
|---|---|---|
| DeleteUserData | DynamoDBのデータ量が多い、スロットリング | Redriveで再実行（ページングで継続処理される） |
| DeleteUserImages | S3アクセスエラー | Redriveで再実行。バケット名・権限を確認 |
| DeleteCognitoUser | Cognitoユーザーが既に削除済み | ログで確認。既に削除済みなら問題なし |

### 4.5 プッシュ通知が送信されない

**症状:** お題公開時にプッシュ通知が届かない

**確認手順:**
1. `{prefix}-scheduled-check-and-publish` Lambdaのログを確認する
2. PushTokensテーブルにトークンが登録されているか確認する
3. Expo Push APIへのリクエストが成功しているか確認する

**原因別対応:**

| 原因 | 対応 |
|---|---|
| PushTokensテーブルにトークンがない | ユーザーが通知を許可していない。正常な動作 |
| Expo Push APIエラー | Expo側の障害の可能性。ステータスページを確認 |
| Lambda実行自体が失敗 | check-and-publish Lambdaのログを確認。Redriveは不要（次の10分サイクルで再試行される） |
| 無効なトークン | Expo API応答で `DeviceNotRegistered` 等が返る場合、トークンを削除する必要あり |

### 4.6 DynamoDBテーブルへのアクセスエラー

**症状:** API呼び出し時にDynamoDB関連のエラーが発生する

**確認手順:**
1. CloudWatchのDynamoDBメトリクスを確認する
   - `ThrottledRequests` -- スロットリング
   - `SystemErrors` -- サービスエラー
   - `UserErrors` -- 条件式の不一致等
2. AWS Health Dashboardで東京リージョンの障害情報を確認する

**原因別対応:**

| 原因 | 対応 |
|---|---|
| スロットリング（ThrottledRequests） | オンデマンドモードのため通常は自動対応。継続する場合はAWSサポートに連絡 |
| サービスエラー（SystemErrors） | AWS側の障害。復旧を待つ |
| テーブルが見つからない | Lambda環境変数のテーブル名が正しいか確認する |

### 4.7 API Gatewayの5XXエラー多発

**症状:** APIが500エラーを返す

**確認手順:**
1. CloudWatchでAPI Gatewayの `5XXError` メトリクスを確認する
2. 対応するLambda関数のログでエラー内容を特定する
3. Sentryでエラーの詳細を確認する

**原因別対応:**

| 原因 | 対応 |
|---|---|
| Lambda関数のエラー | ログを確認し、バグなら修正してデプロイ |
| Lambdaの同時実行数上限 | AWSコンソールで上限を確認。必要に応じて引き上げリクエスト |
| API Gatewayの設定不正 | CDK diffで変更内容を確認。必要に応じてロールバック |
| メモリ不足 | Lambda関数のメモリ設定（256MB）を確認。必要に応じて増量 |

### 4.8 S3プロフィール画像のアクセスエラー

**症状:** プロフィール画像が表示されない、アップロードできない

**確認手順:**
1. S3バケット `{prefix}-profile-images-{accountId}` が存在するか確認する
2. バケットポリシーとCORS設定を確認する
3. Presigned URLが正しく生成されているか確認する

**原因別対応:**

| 原因 | 対応 |
|---|---|
| バケットが存在しない | CDKデプロイで再作成。`removalPolicy: RETAIN` のため手動削除された可能性 |
| 公開設定が変更された | CDK diffで確認し、再デプロイ |
| CORS設定エラー | CDK diffで確認し、再デプロイ |
| Presigned URLの期限切れ | 有効期限は5分。クライアント側の処理を確認 |

---

## 5. 復旧確認手順

### 5.1 復旧後の確認チェックリスト

障害復旧後、以下を確認する:

- [ ] API Gatewayのヘルスチェック: `GET /app/version` が正常に応答するか
- [ ] 認証フロー: ログインが正常に動作するか
- [ ] お題取得: `GET /questions/today` が正常に応答するか
- [ ] タイムライン: `GET /answers/timeline` が正常に応答するか
- [ ] 管理画面: 管理画面APIが正常に応答するか
- [ ] CloudWatch: エラー率が正常値に戻っているか
- [ ] Sentry: 新規エラーが発生していないか

### 5.2 ヘルスチェック用コマンド

```bash
# バージョンチェック（認証不要）
curl -s https://api.{domain}/v1/app/version?platform=ios&version=1.0.0

# 認証付きAPI確認
curl -s https://api.{domain}/v1/questions/today \
  -H "Authorization: Bearer {access_token}"
```

### 5.3 DynamoDBデータ整合性確認

退会処理失敗後の確認:
```bash
# ユーザーデータが削除されているか確認
aws dynamodb get-item --table-name {prefix}-users --key '{"userId":{"S":"{userId}"}}'

# フォロー関係が残っていないか確認
aws dynamodb query --table-name {prefix}-follows --key-condition-expression "followerId = :uid" --expression-attribute-values '{":uid":{"S":"{userId}"}}'
```

---

## 6. ロールバック手順

### 6.1 CDKデプロイのロールバック

直前のデプロイで問題が発生した場合:

```bash
# CloudFormationコンソールから該当スタックのロールバックを実行
# または、gitで前のバージョンに戻してデプロイ
git revert HEAD
cd infra && npx cdk deploy --all --require-approval never
```

**注意事項:**
- DynamoDBテーブルのスキーマ変更はロールバックが困難
- Lambda関数のコード変更は即座にロールバック可能
- API Gatewayの設定変更もロールバック可能

### 6.2 Lambda関数のロールバック

特定のLambda関数のみをロールバックしたい場合は、gitで前のコミットに戻してデプロイする。

---

## 7. 障害記録テンプレート

障害発生時は以下のテンプレートで記録し、`docs/開発トラブルシューティング.md` に追記する。

```markdown
### YYYY-MM-DD: [障害タイトル]

**レベル:** P1/P2/P3/P4

**発生日時:** YYYY-MM-DD HH:MM JST

**検知方法:** Sentry / CloudWatch / ユーザー報告

**影響範囲:** 全ユーザー / 一部ユーザー / 管理者のみ

**症状:**
[何が起きたか]

**原因:**
[根本原因]

**対応内容:**
1. [対応手順1]
2. [対応手順2]

**復旧時刻:** YYYY-MM-DD HH:MM JST

**再発防止策:**
[再発防止のための対策]

**教訓:**
[今回の障害から得た教訓]
```

---

## 8. AWS Health Dashboard

AWSサービスの障害情報は AWS Health Dashboard で確認できる。

- **Service Health Dashboard:** AWS全体のサービス状態
- **Personal Health Dashboard:** 自アカウントに影響する障害・メンテナンス情報

特に以下のサービスの状態を確認:
- Amazon DynamoDB (ap-northeast-1)
- Amazon Cognito (ap-northeast-1)
- Amazon API Gateway (ap-northeast-1)
- AWS Lambda (ap-northeast-1)
- Amazon S3 (ap-northeast-1)
- AWS Step Functions (ap-northeast-1)
- Amazon EventBridge (ap-northeast-1)

---

## 9. 障害時の対外コミュニケーション

### 9.1 ユーザーへの告知基準

| レベル | 告知 |
|---|---|
| P1 | 即座にアプリ内お知らせ等で告知 |
| P2 | 30分以上継続する場合に告知 |
| P3 | 必要に応じて |
| P4 | 告知不要 |

### 9.2 告知テンプレート

**障害発生時:**
```
現在、一部の機能がご利用いただけない状態となっております。
復旧に向けて対応しております。ご不便をおかけし申し訳ございません。
```

**復旧時:**
```
先ほどの障害は復旧いたしました。
ご不便をおかけいたしましたこと、お詫び申し上げます。
```
